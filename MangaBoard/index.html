<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Board Ultimate (Protected)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        window.firebaseModules = { initializeApp, getDatabase, ref, set, get, child, getAuth, signInWithEmailAndPassword };
        window.dispatchEvent(new Event('firebaseLoaded'));
    </script>
    <style>
        :root {
            --bg-color: #2c3e50;
            --col-bg: #ecf0f1;
            --text-color: #000000;
            --page-nav-bg: #34495e;
            --unpaid-color: #3c64e7;
            --paid-color: #27ae60;
            --font-main: 'Sarabun', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- Page Navigation --- */
        .page-nav {
            background-color: var(--page-nav-bg);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            color: white;
            flex-shrink: 0;
        }

        .page-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-label {
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 10px;
            color: #f1c40f;
        }

        /* --- Main Content --- */
        .main-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        header {
            color: white;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        .control-panel {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .input-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .group-label {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 0.85rem;
            margin-right: 5px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .input-text {
            color: #ddd;
            font-size: 0.9rem;
        }

        input,
        select {
            padding: 8px;
            border-radius: 4px;
            border: none;
            outline: none;
            font-family: var(--font-main);
        }

        select {
            min-width: 150px;
            cursor: pointer;
            background-color: #fff;
        }

        input[type="color"] {
            border: none;
            width: 40px;
            height: 35px;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        input[type="checkbox"].bulk-chk {
            width: 16px;
            height: 16px;
            accent-color: #f39c12;
            cursor: pointer;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: var(--font-main);
        }

        .btn-green {
            background-color: #27ae60;
            color: white;
        }

        .btn-green:hover {
            background-color: #2ecc71;
        }

        .btn-blue {
            background-color: #2980b9;
            color: white;
        }

        .btn-orange {
            background-color: #e67e22;
            color: white;
        }

        .btn-red {
            background-color: #c0392b;
            color: white;
        }

        .btn-dark {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #7f8c8d;
        }

        .btn-cloud {
            background-color: #8e44ad;
            color: white;
        }

        /* --- Board Layout --- */
        .board {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow-x: auto;
            padding-bottom: 10px;
            min-height: 0;
            /* Important for flex child scroll */
        }

        .column {
            background-color: var(--col-bg);
            border-radius: 8px;
            min-width: 300px;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-height: 100%;
        }

        .column-header {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 15px;
            padding-right: 15px;
            flex-shrink: 0;
        }

        .column-header.unpaid {
            background-color: var(--unpaid-color);
        }

        .column-header.paid {
            background-color: var(--paid-color);
        }

        .task-count {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .task-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* --- Sticky Note Styles --- */
        .note {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: grab;
            position: relative;
            transition: transform 0.2s, filter 0.2s;
            color: black;
            border-left: 8px solid #ccc;
            background: white;
        }

        .note.paid {
            opacity: 0.9;
            background: #f0fdf4;
            border: 2px solid #27ae60 !important;
        }

        /* Paid items struck */
        .note.paid h3,
        .note.paid .price-tag,
        .note.paid .job-checks {
            text-decoration: line-through;
            color: #c0392b !important;
        }

        .note:hover {
            filter: brightness(95%);
        }

        .note:active {
            cursor: grabbing;
            transform: rotate(2deg) scale(1.02);
            z-index: 100;
        }

        .note h3 {
            margin: 0;
            font-size: 1.05rem;
            color: black;
            font-weight: 800;
            pointer-events: none;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .column.drag-over {
            background-color: #dcdde1;
            border: 2px dashed #7f8c8d;
        }

        .assignee-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .job-checks {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            background: #fdfdfd;
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .check-box {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            color: #7f8c8d;
            font-weight: 500;
        }

        .check-box.checked {
            color: #27ae60;
            font-weight: bold;
        }

        .price-tag {
            font-weight: 800;
            color: #2c3e50;
            text-align: right;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        .payer-tag {
            margin-top: 8px;
            font-size: 0.85rem;
            background: #ecf0f1;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #5865F2;
            /* Discord Blue */
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
            margin-left: 5px;
            border-radius: 4px;
        }

        .btn-icon:hover {
            background-color: #5865F2;
            color: white;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #eba4a4;
            color: #c0392b;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            z-index: 50;
        }

        .delete-btn:hover {
            background: #fee;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 6000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #666;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            border: 1px solid #ddd;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #bdc3c7;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .status-dot.online {
            background-color: #2ecc71;
            box-shadow: 0 0 5px #2ecc71;
        }

        .status-dot.syncing {
            background-color: #f1c40f;
            animation: pulse 1s infinite;
        }

        .status-dot.offline {
            background-color: #e74c3c;
        }

        .status-dot.error {
            background-color: #e74c3c;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
    <style>
        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }

            .main-content {
                height: auto;
                overflow: visible;
                padding: 10px;
            }

            .page-nav {
                flex-direction: column;
                gap: 10px;
            }

            .page-controls {
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }

            /* Main Board Stack */
            .board {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: visible;
                gap: 20px;
                padding-bottom: 20px;
            }

            .column {
                min-width: 100%;
                max-height: 500px;
                overflow-y: auto;
                margin-bottom: 10px;
            }

            /* Inputs */
            .control-panel {
                flex-direction: column;
                gap: 10px;
            }

            .input-group {
                width: 100%;
                flex-wrap: wrap;
                box-sizing: border-box;
            }

            .input-group input,
            .input-group select {
                flex: 1;
            }

            /* Hide non-essential buttons text on mobile or use icons? 
               For now, wrap them */
            .btn-dark,
            .btn-blue,
            .btn-red,
            .btn-green,
            .btn-cloud,
            .btn-orange {
                font-size: 0.9rem;
                padding: 8px;
            }
        }
    </style>
</head>

<body>

    <!-- TOP BAR -->
    <div class="page-nav">
        <div class="page-controls">
            <span class="page-label">üìñ ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô:</span>
            <select id="pageSelect" onchange="switchPage()"
                style="font-size: 1rem; font-weight: bold; padding: 5px 10px;"></select>
            <button class="btn-dark" onclick="createNewPage()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            <button class="btn-dark" onclick="renameCurrentPage()">‚úèÔ∏è</button>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <div class="sync-status">
                <div class="status-dot" id="statusDot"></div><span id="statusText">Offline</span>
            </div>
            <button class="btn-dark" onclick="openPayerModal()">üí≥ ‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Code)</button>
            <button class="btn-dark" onclick="openAssigneeModal()">üë• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</button>
            <button class="btn-cloud" onclick="document.getElementById('cloudModal').style.display='flex'">‚òÅÔ∏è
                Cloud</button>
            <button class="btn-blue" onclick="saveToJSON()">üíæ Backup</button>
            <button class="btn-orange" onclick="secureImportJSON()">üìÇ Import</button>
            <button class="btn-red" onclick="resetAllData()">‚ö†Ô∏è Reset</button>
            <input type="file" id="fileInput" style="display: none;" onchange="handleJSONImportBoard(this)">
        </div>
    </div>

    <!-- Cloud Modal -->
    <div id="cloudModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">‚òÅÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Cloud & Webhook (Firebase)</div>
            <input type="text" id="cfgEmail" placeholder="Email (your-bot-admin@...)"
                style="width:100%; margin-bottom:5px; padding:10px; font-family:monospace;">
            <input type="password" id="cfgPassword" placeholder="Password"
                style="width:100%; margin-bottom:10px; padding:10px; font-family:monospace;">


            <label style="display:block; margin-top:10px; font-weight:bold; font-size:0.9rem;">Webhook
                (‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢):</label>
            <input type="text" id="cfgWebhookUnpaid" placeholder="Unpaid Webhook URL"
                style="width:100%; margin-bottom:10px; padding:8px; box-sizing:border-box; background:#fbeeee;">

            <label style="display:block; margin-top:5px; font-weight:bold; font-size:0.9rem;">Webhook
                (‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß):</label>
            <input type="text" id="cfgWebhookPaid" placeholder="Paid Webhook URL"
                style="width:100%; margin-bottom:15px; padding:8px; box-sizing:border-box; background:#eefbf3;">

            <div style="display:flex; gap:10px;">
                <button class="btn-green" onclick="saveCloudConfig()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                <button class="btn-dark"
                    onclick="document.getElementById('cloudModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
            </div>
            <button class="btn-blue" style="margin-top:10px; width:100%; justify-content:center;"
                onclick="forceSync()">üì• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>

    <!-- Assignee Modal -->
    <div id="assigneeModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö üë•</div>
            <div style="margin-bottom:15px; display:flex; flex-direction:column; gap:5px;">
                <input type="text" id="newAssigneeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠..."
                    style="width:100%; padding:8px; box-sizing:border-box;">
                <input type="text" id="newAssigneeDiscord" placeholder="Discord ID (e.g. 123456789)"
                    style="width:100%; padding:8px; box-sizing:border-box;">
                <div style="display:flex; gap:5px;">
                    <input type="color" id="newAssigneeColor" value="#3498db" style="height:35px; width:50px;">
                    <button class="btn-green" style="flex:1; justify-content:center;"
                        onclick="addAssignee()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>
            <div id="assigneeListModal" style="max-height:300px; overflow-y:auto;"></div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-dark"
                    onclick="document.getElementById('assigneeModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Payer Modal -->
    <div id="payerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô üí≥ (Secure)</div>
            <div style="margin-bottom:15px; display:flex; flex-direction:column; gap:5px;">
                <input type="text" id="newPayerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢..."
                    style="width:100%; padding:8px; box-sizing:border-box;">
                <input type="text" id="newPayerDiscord" placeholder="Discord ID"
                    style="width:100%; padding:8px; box-sizing:border-box;">
                <!-- SECURITY CODE -->
                <input type="password" id="newPayerCode" placeholder="üîí ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Code)"
                    style="width:100%; padding:8px; box-sizing:border-box; border:1px solid #e74c3c; background:#fff5f5;">

                <button class="btn-green" style="width:100%; justify-content:center;"
                    onclick="addPayer()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div id="payerListModal" style="max-height:300px; overflow-y:auto;"></div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-dark"
                    onclick="document.getElementById('payerModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Payment Prompt Modal -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üí∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div>
            <p id="payModalTitle" style="margin-bottom:15px;"></p>

            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢:</label>
            <select id="paySelectPayer" style="width:100%; margin-bottom:10px; padding:10px;"></select>

            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Code):</label>
            <input type="password" id="payInputCode" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢..."
                style="width:100%; margin-bottom:5px; padding:10px; box-sizing:border-box; border:1px solid #3498db;">

            <label id="payLabelSlip" style="display:none; margin-top:10px; font-weight:bold;">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏µ‡∏õ (Slip):</label>
            <input type="file" id="payInputSlip" accept="image/*" style="display:none; margin-bottom:15px; width:100%;">

            <div style="display:flex; gap:10px;">
                <button class="btn-green" onclick="confirmPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏à‡πà‡∏≤‡∏¢</button>
                <button class="btn-dark" onclick="cancelPayment()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Bulk Payment Modal -->
    <div id="bulkPaymentModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Bulk Pay)</div>
            <div id="bulkPreview"
                style="max-height:150px; overflow-y:auto; font-size:0.85rem; background:#f4f4f4; padding:10px; margin-bottom:10px; border-radius:5px;">
            </div>

            <p id="bulkTotalLabel" style="font-weight:bold; font-size:1.1rem; text-align:right; margin-bottom:10px;">
                ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: 0 ‡∏ö‡∏≤‡∏ó</p>

            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢:</label>
            <select id="bulkSelectPayer" style="width:100%; margin-bottom:10px; padding:10px;"></select>

            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Code):</label>
            <input type="password" id="bulkInputCode" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢..."
                style="width:100%; margin-bottom:5px; padding:10px; box-sizing:border-box; border:1px solid #3498db;">

            <label style="margin-top:10px; font-weight:bold;">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏µ‡∏õ (Slip):</label>
            <input type="file" id="bulkInputSlip" accept="image/*" style="margin-bottom:15px; width:100%;">

            <div style="display:flex; gap:10px;">
                <button class="btn-green" onclick="confirmBulkPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</button>
                <button class="btn-dark"
                    onclick="document.getElementById('bulkPaymentModal').style.display='none'">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Summary Modal (Integrated & Filtered) -->
    <div id="summaryModal" class="modal-overlay">
        <div class="modal-box" style="max-width:1100px;">
            <div class="modal-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Advanced Filter)</div>

            <div
                style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="flex:1; min-width:120px;">
                    <small>‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Payer):</small>
                    <select id="filterSumPayer" style="width:100%;" onchange="renderSummaryTable()">
                        <option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div style="flex:1; min-width:120px;">
                    <small>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Assignee):</small>
                    <select id="filterSumAssignee" style="width:100%;" onchange="renderSummaryTable()">
                        <option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div style="flex:1; min-width:120px;">
                    <small>‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Page):</small>
                    <select id="filterSumPage" style="width:100%;" onchange="renderSummaryTable()">
                        <option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div style="flex:1; min-width:120px;">
                    <small>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Project):</small>
                    <select id="filterSumProject" style="width:100%;" onchange="renderSummaryTable()">
                        <option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div style="flex:1; min-width:120px;">
                    <small>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month):</small>
                    <select id="filterSumMonth" style="width:100%;" onchange="renderSummaryTable()">
                        <option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
            </div>

            <div id="summaryStats" style="display:flex; gap:10px; margin-bottom:10px;">
                <!-- Auto Generated Stats -->
            </div>

            <div id="summaryTable" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
            </div>

            <div style="margin-top:10px; text-align:right;">
                <button class="btn-dark"
                    onclick="document.getElementById('summaryModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <div class="control-panel">
                <!-- ZONE 1 -->
                <div class="input-group" style="border-left: 4px solid #f1c40f;">
                    <span class="group-label">1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
                    <input type="text" id="newProjName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." style="width: 120px;">
                    <input type="color" id="newProjColor" value="#f1c40f">
                    <button class="btn-green" onclick="createProject()">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                </div>
                <!-- ZONE 2: Updated Input -->
                <div class="input-group" style="border-left: 4px solid #3498db;">
                    <span class="group-label">2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</span>
                    <select id="projectSelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á --</option>
                    </select>
                    <!-- Hide delete project button but keep logic available via console if needed -->
                    <button class="btn-red" onclick="deleteCurrentProject()" style="padding: 5px 10px;"
                        title="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">üóëÔ∏è</button>

                    <select id="assigneeSelect" style="width: 110px;">
                        <option value="">-- ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö --</option>
                    </select>

                    <input type="number" id="inputStart" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°" style="width: 50px;">
                    <span class="input-text">-</span>
                    <input type="number" id="inputEnd" placeholder="‡∏ñ‡∏∂‡∏á" style="width: 50px;">

                    <!-- New Checkboxes -->

                    <div style="display:flex; flex-direction:column; gap:2px; font-size:0.8rem; margin-left:5px;">
                        <label title="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î"><input type="checkbox" id="chkInitDownload">
                            ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label>
                        <label title="‡∏î‡∏π‡∏î‡∏Ñ‡∏•‡∏µ‡∏ô 50 ‡∏ö."><input type="checkbox" id="chkInitClean" checked> ‡∏î‡∏π‡∏î‡∏Ñ‡∏•‡∏µ‡∏ô
                            50‡∏ø</label>
                        <label title="‡∏•‡∏á‡∏Ñ‡∏≥ 30 ‡∏ö."><input type="checkbox" id="chkInitTypeset"> ‡∏•‡∏á‡∏Ñ‡∏≥ 30‡∏ø</label>
                    </div>
                    <label
                        style="font-size:0.75rem; display:flex; flex-direction:column; align-items:center; margin-left:5px; cursor:pointer;">
                        <input type="checkbox" id="chkInitWebhook" checked> Auto<br>Dc
                    </label>
                    <button class="btn-green" onclick="addNote()">+</button>
                </div>
                <!-- ZONE 3 -->
                <div class="input-group" style="border-left: 4px solid #9b59b6; flex-grow: 1;">
                    <span class="group-label">3. ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</span>
                    <select id="filterSelect" onchange="updateFilter()">
                        <option value="ALL">üìÇ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                    <select id="filterAssignee" onchange="updateFilter()" style="margin-left:5px;">
                        <option value="ALL">üë§ ‡∏Ñ‡∏ô: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>

                    <button class="btn-blue" onclick="openSummaryModal()" style="margin-left:auto;">üìä
                        ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>
        </header>

        <div class="board">
            <!-- Unpaid Column -->
            <div class="column" id="unpaid" ondrop="drop(event)" ondragover="allowDrop(event)"
                ondragleave="leaveDrop(event)">
                <div class="column-header unpaid">
                    <span>‚úçÔ∏è ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span> <span class="task-count" id="cnt-unpaid">0</span>
                    <button class="btn-dark" style="font-size:0.7rem; margin-left:auto;"
                        onclick="toggleSort('unpaid')">Sort ‚ÜïÔ∏è</button>
                </div>
                <div class="task-container" id="container-unpaid"></div>
            </div>

            <!-- To Pay Column (New) -->
            <div class="column" id="topay" ondrop="drop(event)" ondragover="allowDrop(event)"
                ondragleave="leaveDrop(event)">
                <div class="column-header" style="background-color:#f39c12;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span>üÜó ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                        <button class="btn-dark" style="font-size:0.7rem; padding: 2px 5px;"
                            onclick="openBulkPayModal()">üí∞ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</button>
                    </div>
                    <span class="task-count" id="cnt-topay">0</span>
                    <button class="btn-dark" style="font-size:0.7rem; margin-left:auto;"
                        onclick="toggleSort('topay')">Sort ‚ÜïÔ∏è</button>
                </div>
                <div class="task-container" id="container-topay"></div>
            </div>

            <!-- Paid Column  -->
            <div class="column" id="paid" ondrop="drop(event)" ondragover="allowDrop(event)"
                ondragleave="leaveDrop(event)">
                <div class="column-header paid">
                    <span>‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Paid)</span>
                    <div style="display:flex; align-items:center; gap:5px; margin-left:auto;">
                        <span class="task-count" id="cnt-paid">0</span>
                    </div>
                </div>
                <div class="task-container" id="container-paid"></div>
            </div>
        </div>
    </div>

    <script>
        // Data Structures
        let pages = [], projects = [], tasks = [], assignees = [], payers = [], currentPageId = '';
        let cloudConfig = { binId: '', webhookUnpaid: '', webhookPaid: '' };
        const defaultFirebaseConfig = {
            apiKey: "FIREBASE_KEY_AUTO_REPLACE",
            authDomain: "manga-bot-db-c3261.firebaseapp.com",
            databaseURL: "https://manga-bot-db-c3261-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "manga-bot-db-c3261",
            storageBucket: "manga-bot-db-c3261.firebasestorage.app",
            messagingSenderId: "588175069162",
            appId: "1:588175069162:web:ac1bb4576222dc32726c93"
        };
        const STORAGE_KEY = 'mangaTracker_V5_Ultimate';

        // Globals -> Added topay sort state
        let sortState = { unpaid: 'default', topay: 'default', paid: 'default' };
        let currentFilterProj = 'ALL';
        let draggedTaskId = null;
        let dragTargetCol = null;

        // Catch global errors
        window.onerror = function (msg, url, line, col, error) {
            alert("Error detected: " + msg + "\nPlease text developer.");
            return false;
        };

        window.onload = function () {
            try {
                loadData();
            } catch (e) {
                alert("Critical Error Loading Data: " + e.message);
                console.error(e);
            }
        };

        function loadData() {
            const rawData = localStorage.getItem(STORAGE_KEY);
            if (rawData) {
                try {
                    const data = JSON.parse(rawData);
                    pages = data.pages || [];
                    projects = data.projects || [];
                    tasks = data.tasks || [];
                    assignees = data.assignees || [];
                    payers = data.payers || [];
                    currentPageId = data.currentPageId || (pages[0] ? pages[0].id : '');
                    cloudConfig = data.cloudConfig || { binId: '', webhookUnpaid: '', webhookPaid: '' };
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    // Fallback init
                }
            }

            if (pages.length === 0) {
                const defId = 'page_' + Date.now();
                pages = [{ id: defId, name: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' }];
                currentPageId = defId;
            }

            // Safety Checks
            if (!Array.isArray(tasks)) tasks = [];
            if (!Array.isArray(assignees)) assignees = [];
            if (!Array.isArray(payers)) payers = [];

            tasks.forEach(t => {
                if (!t.createdAt) t.createdAt = new Date().toISOString();
                if (!t.job) t.job = { clean: false, typeset: false };
                if (!t.payerId) t.payerId = '';
                // Ensure existing tasks have a status that fits the new workflow
                if (!t.status) t.status = 'unpaid'; // Default old tasks to unpaid
                if (t.status === 'unpaid' && t.payerId) t.status = 'topay'; // If it has a payerId but is unpaid, it should be 'to pay'
            });

            payers.forEach(p => { if (!p.code) p.code = ''; });

            // --- Auto-Login Logic (URL Params) ---
            const urlParams = new URLSearchParams(window.location.search);
            const paramBin = urlParams.get('bin');
            const paramKey = urlParams.get('key');
            if (paramBin && paramKey) {
                cloudConfig.binId = paramBin;
                cloudConfig.apiKey = paramKey;

                // Save to LocalStorage immediately (Without triggering syncToCloud yet)
                const data = { pages, projects, tasks, assignees, payers, currentPageId, cloudConfig };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => showToast("üîë ‡∏£‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."), 500);
            }

            // Auto-Login Firebase
            const fbConfigParam = urlParams.get('firebaseConfig');
            if (fbConfigParam) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(fbConfigParam));
                    // Preserve webhooks if they exist
                    const oldWhU = cloudConfig.webhookUnpaid;
                    const oldWhP = cloudConfig.webhookPaid;
                    cloudConfig = { ...decoded, webhookUnpaid: oldWhU, webhookPaid: oldWhP };
                    saveLocal();
                    window.history.replaceState({}, document.title, window.location.pathname);
                    showToast("üîë Firebase Config Loaded");
                } catch (e) { console.error("URL Config Error", e); }
            }

            // Apply Default Config if missing (except apiKey)
            // Merge defaults
            cloudConfig = { ...defaultFirebaseConfig, ...cloudConfig };

            // Init Config UI
            const elU = document.getElementById('cfgWebhookUnpaid'); if (elU) elU.value = cloudConfig.webhookUnpaid || '';
            const elP = document.getElementById('cfgWebhookPaid'); if (elP) elP.value = cloudConfig.webhookPaid || '';

            // Init Firebase if config exists
            if (cloudConfig.apiKey && window.firebaseModules) initFirebaseSystem();

            // Fill Input
            const ta = document.getElementById('cfgFirebase');
            if (ta) ta.value = cloudConfig.apiKey || '';

            refreshUI(); // This was renderPageSelect, renderProjectDropdowns, renderAssignees, renderSummaryFilterOptions, renderTasks, renderPayersDropdown
            if (cloudConfig.apiKey && window.firebaseModules) forceSync(); // Sync on start if Firebase is configured
        }

        let firebaseApp, db, auth;

        window.addEventListener('firebaseLoaded', () => {
            initFirebaseSystem();
        });

        async function initFirebaseSystem() {
            try {
                const { initializeApp, getDatabase, getAuth, signInWithEmailAndPassword } = window.firebaseModules;

                // 1. Initialize App (Always use default config with hardcoded key)
                cloudConfig = { ...defaultFirebaseConfig, ...cloudConfig, apiKey: defaultFirebaseConfig.apiKey };

                if (!firebaseApp) {
                    firebaseApp = initializeApp(cloudConfig);
                }
                db = getDatabase(firebaseApp);
                auth = getAuth(firebaseApp);

                // 2. Check URL Params for Credentials
                const urlParams = new URLSearchParams(window.location.search);
                const pEmail = urlParams.get('email');
                const pPass = urlParams.get('password');

                // 3. Fallback to Local Storage or Default
                let savedEmail = localStorage.getItem('manga_email') || "your-bot-admin@yourdomain.com";
                let savedPass = localStorage.getItem('manga_password') || "your-secure-password";

                let email = pEmail || savedEmail;
                let password = pPass || savedPass;

                // Fill Inputs if Modal Open
                const inpEmail = document.getElementById('cfgEmail');
                const inpPass = document.getElementById('cfgPassword');
                if (inpEmail) inpEmail.value = email;
                if (inpPass) inpPass.value = password;

                console.log("Attempting Login with:", email);

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("Login Success");
                    showToast("‚úÖ Login Success");

                    document.getElementById('statusDot').className = 'status-dot online';
                    document.getElementById('statusText').innerText = 'Online';

                    // Save successful creds
                    localStorage.setItem('manga_email', email);
                    localStorage.setItem('manga_password', password);

                    await forceSync(); // Sync on start

                    // Clean URL if params existed
                    if (pEmail || pPass) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }

                } catch (authErr) {
                    console.error("Auth Failed", authErr);
                    showToast("‚ùå Auth Failed: " + authErr.code);
                }

            } catch (e) {
                console.error("Firebase Init Failed", e);
            }
        }

        function autoSave() {
            saveLocal();
            syncToCloud();
        }

        function saveLocal() {
            const data = { pages, projects, tasks, assignees, payers, currentPageId, cloudConfig };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // --- Cloud Info ---
        async function saveCloudConfig() {
            try {
                const email = document.getElementById('cfgEmail').value.trim();
                const password = document.getElementById('cfgPassword').value.trim();

                // Merge webhook with config
                const whU = document.getElementById('cfgWebhookUnpaid').value.trim();
                const whP = document.getElementById('cfgWebhookPaid').value.trim();

                cloudConfig = { ...defaultFirebaseConfig, webhookUnpaid: whU, webhookPaid: whP };
                saveLocal();

                // Trigger Re-Auth
                localStorage.setItem('manga_email', email);
                localStorage.setItem('manga_password', password);

                await initFirebaseSystem();

                // Re-apply webhooks (in case syncFromCloud overwrote them with old cloud data)
                cloudConfig.webhookUnpaid = whU;
                cloudConfig.webhookPaid = whP;
                saveLocal();

                // Push new config to cloud
                if (db) {
                    await syncToCloud();
                }

                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...");
                document.getElementById('cloudModal').style.display = 'none';
            } catch (e) {
                alert("Config Error: " + e.message);
            }
        }

        async function sendDiscordWebhook(task, type, file = null) {
            let url = ''; let payload = {};
            const assignee = assignees.find(a => a.id === task.assigneeId);
            const assigneeName = assignee ? assignee.name : 'Unknown';
            let assigneeTag = (assignee && assignee.discordId) ? `<@${assignee.discordId}>` : assigneeName;

            let jobDesc = [];
            if (task.job.download) jobDesc.push("‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î");
            if (task.job.clean) jobDesc.push("‡∏î‡∏π‡∏î‡∏Ñ‡∏•‡∏µ‡∏ô");
            if (task.job.typeset) jobDesc.push("‡∏•‡∏á‡∏Ñ‡∏≥");
            const jobStr = jobDesc.join(" + ") || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô";
            const price = calculatePrice(task);

            // Pings Control
            let pingUsers = [];

            if (type === 'new' || type === 'unpaid') {
                // New Task: Ping Assignee
                if (assignee && assignee.discordId) pingUsers.push(assignee.discordId);

                url = cloudConfig.webhookUnpaid;
                if (!url) return;
                payload = { content: `‚úçÔ∏è **‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô**\n**${task.title}**\n‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${task.chapter}\n${jobStr}\n${assigneeTag}` };

            } else if (type === 'topay') {
                // To Pay: Tag Payer
                url = cloudConfig.webhookPaid; // Use Financial Webhook
                if (!url) return;
                const payer = payers.find(p => p.id === task.payerId);
                const payerTag = (payer && payer.discordId) ? `<@${payer.discordId}>` : (payer ? payer.name : 'Unknown Payer');
                // Format: Title | ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö : Name \n Chapter \n Job Price \n @Payer
                // Assignee Name is just text here, not a ping, because Payer is being pinged at the bottom
                // If you want Assignee to be pinged silent, we rely on @silent at start
                payload = {
                    content: `**${task.title}** | ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö :${assigneeTag}\n‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${task.chapter}\n${jobStr} **${price} ‡∏ö‡∏≤‡∏ó**\n${payerTag}`,

                    // üëá ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏≤‡∏Å allowed_mentions ‡πÄ‡∏õ‡πá‡∏ô allowedMentions
                    allowedMentions: {
                        users: [payer.discordId]  // ‡πÉ‡∏™‡πà ID ‡πÉ‡∏Ñ‡∏£ ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏î‡πâ‡∏á (‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏Å‡∏£‡∏¥‡∏ö)
                    }
                }

            } else if (type === 'paid') {
                // Paid: Tag Assignee
                url = cloudConfig.webhookPaid;
                if (!url) return;

                // Format: Title | ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß \n Chapter \n ~~Job Price~~ \n @Assignee
                payload = { content: `*${task.title}** | **‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß**\n‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${task.chapter}\n~~${jobStr} **${price} ‡∏ö‡∏≤‡∏ó**~~\n${assigneeTag}` };
            } else if (type === 'cancel') {
                url = cloudConfig.webhookUnpaid;
                if (!url) return;
                payload = { content: `**${task.title}** | **‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å**\n‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${task.chapter}\n${assigneeTag}` };
            }

            try {
                if (file) {
                    const formData = new FormData();
                    formData.append('payload_json', JSON.stringify(payload));
                    formData.append('file', file);
                    await fetch(url, { method: 'POST', body: formData });
                } else {
                    await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                }
            } catch (e) { console.error("Webhook Error", e); }
        }

        async function syncFromCloud() {
            if (!db) return;
            document.getElementById('statusDot').className = 'status-dot syncing';
            document.getElementById('statusText').innerText = 'Syncing...';
            try {
                const { ref, get, child } = window.firebaseModules;
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, 'manga_board/'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.pages) {
                        pages = data.pages || [];
                        projects = data.projects || [];
                        tasks = data.tasks || [];
                        assignees = data.assignees || [];
                        payers = data.payers || [];

                        // Sync Cloud Config (Webhooks)
                        if (data.cloudConfig) {
                            cloudConfig.webhookUnpaid = data.cloudConfig.webhookUnpaid || '';
                            cloudConfig.webhookPaid = data.cloudConfig.webhookPaid || '';
                            // Refresh UI Inputs
                            const elU = document.getElementById('cfgWebhookUnpaid'); if (elU) elU.value = cloudConfig.webhookUnpaid;
                            const elP = document.getElementById('cfgWebhookPaid'); if (elP) elP.value = cloudConfig.webhookPaid;
                        }

                        saveLocal();
                        refreshUI();
                        console.log("Cloud Loaded");
                        showToast("‚¨áÔ∏è Synced");
                    }
                }
                document.getElementById('statusDot').className = 'status-dot online';
                document.getElementById('statusText').innerText = 'Online';
            } catch (e) {
                console.error("Cloud Load Error", e);
                document.getElementById('statusDot').className = 'status-dot offline';
                document.getElementById('statusText').innerText = 'Offline';
            }
        }

        async function syncToCloud() {
            if (!db) return;
            document.getElementById('statusDot').className = 'status-dot syncing';
            document.getElementById('statusText').innerText = 'Saving...';
            try {
                const { ref, set } = window.firebaseModules;
                await set(ref(db, 'manga_board/'), {
                    pages, projects, tasks, assignees, payers, cloudConfig, updated: new Date().toISOString()
                });
                console.log("Cloud Saved");
                document.getElementById('statusDot').className = 'status-dot online';
                document.getElementById('statusText').innerText = 'Online';
            } catch (e) {
                console.error("Cloud Save Error", e);
                document.getElementById('statusDot').className = 'status-dot offline';
                document.getElementById('statusText').innerText = 'Err Save';
            }
        }

        function forceSync() { return syncFromCloud(); }

        function refreshUI() {
            renderPageSelect();
            renderProjectDropdowns();
            renderAssigneeDropdown();
            renderTasks();
        }

        // --- Page & Project ---
        function renderPageSelect() {
            const sel = document.getElementById('pageSelect');
            if (!sel) return;
            sel.innerHTML = '';
            pages.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); });
            sel.value = currentPageId;
        }
        async function switchPage() {
            const targetPageId = document.getElementById('pageSelect').value;
            if (db) {
                try {
                    showToast('Syncing Page...');
                    await syncFromCloud();
                } catch (e) { console.error(e); }
            }
            // Ensure the page still exists after sync, or fallback
            if (pages.find(p => p.id === targetPageId)) {
                currentPageId = targetPageId;
            } else {
                alert("This page no longer exists on cloud!");
                currentPageId = pages[0].id;
            }
            currentFilterProj = 'ALL';
            saveLocal();
            refreshUI();
        }
        async function createNewPage() {
            const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:");
            if (n) {
                if (db) { try { await syncFromCloud(); } catch (e) { } }
                const id = 'page_' + Date.now(); pages.push({ id, name: n }); currentPageId = id; autoSave(); refreshUI();
            }
        }
        async function renameCurrentPage() {
            if (db) { try { await syncFromCloud(); } catch (e) { } }
            const cur = pages.find(p => p.id === currentPageId); const n = prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠:", cur.name);
            if (n) { cur.name = n; autoSave(); refreshUI(); }
        }

        async function createProject() {
            const n = document.getElementById('newProjName').value.trim();
            const c = document.getElementById('newProjColor').value;
            if (!n) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á");

            // Sync before adding to prevent overwrite
            if (db) { try { await syncFromCloud(); } catch (e) { } }

            if (projects.some(p => p.pageId === currentPageId && p.name === n)) return alert("‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
            projects.push({ name: n, color: c, pageId: currentPageId });
            autoSave(); document.getElementById('newProjName').value = ''; renderProjectDropdowns(); document.getElementById('projectSelect').value = n;
        }
        async function deleteCurrentProject() {
            const n = document.getElementById('projectSelect').value;
            // Sync before delete
            if (db) { try { await syncFromCloud(); } catch (e) { } }

            if (projects.some(p => p.pageId === currentPageId && p.name === n)) {
                if (n && confirm(`‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${n}"? (‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`)) {
                    projects = projects.filter(p => !(p.pageId === currentPageId && p.name === n));
                    autoSave(); renderProjectDropdowns();
                }
            } else {
                renderProjectDropdowns();
            }
        }
        function renderProjectDropdowns() {
            const addS = document.getElementById('projectSelect'); const filS = document.getElementById('filterSelect');
            if (!addS || !filS) return;
            const pList = projects.filter(p => p.pageId === currentPageId);
            addS.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á --</option>'; filS.innerHTML = '<option value="ALL">üìÇ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            pList.forEach(p => {
                let o1 = document.createElement('option'); o1.value = p.name; o1.textContent = p.name; o1.style.backgroundColor = p.color; addS.appendChild(o1);
                let o2 = document.createElement('option'); o2.value = p.name; o2.textContent = p.name; filS.appendChild(o2);
            });
            filS.value = currentFilterProj;
        }

        // --- Lists ---
        function openAssigneeModal() { renderAssigneeListModal(); document.getElementById('assigneeModal').style.display = 'flex'; }
        function openPayerModal() { renderPayerListModal(); document.getElementById('payerModal').style.display = 'flex'; }

        function addAssignee() {
            const n = document.getElementById('newAssigneeName').value.trim();
            const c = document.getElementById('newAssigneeColor').value;
            const d = document.getElementById('newAssigneeDiscord').value.trim();
            if (!n) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
            assignees.push({ id: 'as_' + Date.now(), name: n, color: c, discordId: d });
            document.getElementById('newAssigneeName').value = ''; autoSave(); renderAssigneeListModal(); renderAssigneeDropdown();
        }

        function addPayer() {
            const n = document.getElementById('newPayerName').value.trim();
            const d = document.getElementById('newPayerDiscord').value.trim();
            const code = document.getElementById('newPayerCode').value.trim();
            if (!n) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
            if (!code) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ (Code) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢");
            payers.push({ id: 'py_' + Date.now(), name: n, discordId: d, code: code });
            document.getElementById('newPayerName').value = ''; document.getElementById('newPayerCode').value = '';
            autoSave(); renderPayerListModal();
        }

        function deleteAssignee(id) { if (confirm("‡∏•‡∏ö?")) { assignees = assignees.filter(a => a.id !== id); autoSave(); renderAssigneeListModal(); renderAssigneeDropdown(); } }
        function deletePayer(id) { if (confirm("‡∏•‡∏ö?")) { payers = payers.filter(a => a.id !== id); autoSave(); renderPayerListModal(); } }

        function renderAssigneeListModal() {
            const cont = document.getElementById('assigneeListModal'); cont.innerHTML = '';
            assignees.forEach(a => {
                const d = document.createElement('div'); d.style.cssText = 'display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; align-items:center;';
                d.innerHTML = `<div><span style="display:inline-block; width:15px; height:15px; background:${a.color}; border-radius:50%; margin-right:5px;"></span><b>${a.name}</b></div><button class="btn-red" onclick="deleteAssignee('${a.id}')">‡∏•‡∏ö</button>`;
                cont.appendChild(d);
            });
        }
        function renderPayerListModal() {
            const cont = document.getElementById('payerListModal'); cont.innerHTML = '';
            payers.forEach(p => {
                const d = document.createElement('div'); d.style.cssText = 'display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; align-items:center;';
                d.innerHTML = `<div><b>${p.name}</b> (Code Set)</div><button class="btn-red" onclick="deletePayer('${p.id}')">‡∏•‡∏ö</button>`;
                cont.appendChild(d);
            });
        }
        function renderAssigneeDropdown() {
            const sel = document.getElementById('assigneeSelect');
            const filterSel = document.getElementById('filterAssignee');
            if (sel) { sel.innerHTML = '<option value="">-- ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö --</option>'; assignees.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; sel.appendChild(o); }); }
            if (filterSel) { filterSel.innerHTML = '<option value="ALL">üë§ ‡∏Ñ‡∏ô: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'; assignees.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; filterSel.appendChild(o); }); }
        }

        // --- Tasks ---
        async function addNote() {
            const n = document.getElementById('projectSelect').value;
            const assigneeId = document.getElementById('assigneeSelect').value;
            const s = parseInt(document.getElementById('inputStart').value);
            let e = parseInt(document.getElementById('inputEnd').value);

            const isDownload = document.getElementById('chkInitDownload').checked;
            const isClean = document.getElementById('chkInitClean').checked;
            const isTypeset = document.getElementById('chkInitTypeset').checked;
            const doAutoSend = document.getElementById('chkInitWebhook').checked;

            if (!n) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á");
            if (isNaN(s)) return alert("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô"); // inputStart is required

            // If inputEnd is empty or NaN, default to inputStart (Single Chapter)
            if (isNaN(e)) e = s;

            if (e < s) return alert("‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô‡∏ú‡∏¥‡∏î (End < Start)");

            // Sync before adding (Now safe to do because syncFromCloud preserves page)
            if (db) {
                try {
                    const savedProj = document.getElementById('projectSelect').value;
                    const savedAss = document.getElementById('assigneeSelect').value;
                    await syncFromCloud();
                    // Restore UI selection
                    if (document.getElementById('projectSelect')) document.getElementById('projectSelect').value = savedProj;
                    if (document.getElementById('assigneeSelect')) document.getElementById('assigneeSelect').value = savedAss;
                } catch (e) { console.error("Pre-add sync failed", e); }
            }

            const proj = projects.find(p => p.pageId === currentPageId && p.name === n);
            const c = proj ? proj.color : '#eee';

            // Format Chapter String: if 1 == 1 -> "1", else "1-3"
            const chapterStr = (s === e) ? s.toString() : `${s}-${e}`;

            const newTask = {
                id: '_' + Math.random().toString(36).substr(2, 9),
                title: n,
                chapter: chapterStr,
                status: 'unpaid', // New tasks start as unpaid
                job: { download: isDownload, clean: isClean, typeset: isTypeset },
                assigneeId: assigneeId || null,
                color: c,
                pageId: currentPageId,
                createdAt: new Date().toISOString(),
                payerId: ''
            };
            tasks.push(newTask);

            if (doAutoSend) sendDiscordWebhook(newTask, 'new');
            autoSave(); renderTasks();
            document.getElementById('inputStart').value = '';
            document.getElementById('inputEnd').value = '';
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        async function deleteNote(id) {
            // 1. Sync First
            if (db) {
                try {
                    showToast('Checking Cloud...');
                    await syncFromCloud();
                } catch (e) { console.error('Sync fail', e); }
            }

            // 2. Locate Task
            const task = tasks.find(t => t.id === id);
            if (!task) {
                alert("‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô");
                renderTasks();
                return;
            }

            // 3. Security Check
            if (task.status === 'paid') {
                const code = prompt("üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (del888):");
                if (code !== 'del888') {
                    return alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ");
                }
            }

            // 4. Confirm Delete
            if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                tasks = tasks.filter(t => t.id !== id);
                autoSave();
                renderTasks();
            }
        }

        async function cancelTask(id) {
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô "${t.title} #${t.chapter}" ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Discord ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                await sendDiscordWebhook(t, 'cancel');
                // Delete task after sending notification
                tasks = tasks.filter(x => x.id !== id);
                autoSave();
                renderTasks();
                showToast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }
        }

        async function updateJob(id, type, checked) {
            // Sync before update
            if (db) {
                try {
                    showToast("Syncing...");
                    await syncFromCloud();
                } catch (e) { console.error(e); }
            }
            const t = tasks.find(x => x.id === id);
            if (t) { t.job[type] = checked; autoSave(); renderTasks(); }
            else { alert('Task may have been deleted.'); renderTasks(); }
        }

        function calculatePrice(t) {
            let p = 0;
            // Calculate Count from Range
            let count = 1;
            if (t.chapter && t.chapter.includes('-')) {
                const parts = t.chapter.split('-');
                const s = parseFloat(parts[0]);
                const e = parseFloat(parts[1]);
                if (!isNaN(s) && !isNaN(e) && e >= s) {
                    count = Math.floor(e - s) + 1;
                }
            }

            if (t.job && t.job.clean) p += 50;
            if (t.job && t.job.typeset) p += 30;
            return p * count;
        }

        function toggleSort(column) {
            const states = ['default', 'asc', 'desc'];
            let current = sortState[column];
            let nextIndex = (states.indexOf(current) + 1) % states.length;
            sortState[column] = states[nextIndex];
            renderTasks();
        }

        function compareTasks(a, b, direction) {
            if (a.title !== b.title) return a.title.localeCompare(b.title);
            const numA = parseFloat(a.chapter); const numB = parseFloat(b.chapter);
            if (!isNaN(numA) && !isNaN(numB)) return direction === 'asc' ? numA - numB : numB - numA;
            return direction === 'asc' ? a.chapter.localeCompare(b.chapter, undefined, { numeric: true }) : b.chapter.localeCompare(a.chapter, undefined, { numeric: true });
        }

        function updateFilter() {
            currentFilterProj = document.getElementById('filterSelect').value;
            currentFilterAssignee = document.getElementById('filterAssignee').value;
            renderTasks();
        }

        function renderTasks() {
            const cont = { unpaid: document.getElementById('container-unpaid'), topay: document.getElementById('container-topay'), paid: document.getElementById('container-paid') };
            if (!cont.unpaid || !cont.paid || !cont.topay) return;
            cont.unpaid.innerHTML = ''; cont.topay.innerHTML = ''; cont.paid.innerHTML = '';

            let groups = { unpaid: [], topay: [], paid: [] };
            const assigneeFilter = document.getElementById('filterAssignee') ? document.getElementById('filterAssignee').value : 'ALL';
            const filteredTasks = tasks.filter(t => {
                if (t.pageId !== currentPageId) return false;
                if (currentFilterProj !== 'ALL' && t.title !== currentFilterProj) return false;
                if (assigneeFilter !== 'ALL' && t.assigneeId !== assigneeFilter) return false;
                return true;
            });
            filteredTasks.forEach(t => {
                if (t.status === 'paid') groups.paid.push(t);
                else if (t.status === 'topay') groups.topay.push(t);
                else groups.unpaid.push(t); // Default to unpaid
            });

            ['unpaid', 'topay', 'paid'].forEach(status => {
                if (sortState[status] !== 'default') { groups[status].sort((a, b) => compareTasks(a, b, sortState[status])); }
                groups[status].forEach(t => {
                    const el = document.createElement('div');
                    el.className = `note ${status}`; el.id = t.id;

                    // Lock Paid Tasks
                    if (status === 'paid') {
                        el.draggable = false;
                        el.style.cursor = 'default';
                        el.style.opacity = '0.9';
                    } else {
                        el.draggable = true;
                        el.ondragstart = drag;
                    }

                    el.style.borderLeftColor = t.color;

                    let assigneeHtml = '';
                    if (t.assigneeId) {
                        const ag = assignees.find(a => a.id === t.assigneeId);
                        assigneeHtml = ag ? `<div class="assignee-badge" style="background:${ag.color}">${ag.name}</div>` : '';
                    }

                    const price = calculatePrice(t);
                    const job = t.job || { download: false, clean: false, typeset: false };

                    let payerHtml = '';
                    if (status === 'paid') {
                        const pObj = payers.find(p => p.id === t.payerId);
                        const pName = pObj ? pObj.name : 'Unknown';
                        payerHtml = `<div class="payer-tag">üí∏ ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: <b>${pName}</b></div>`;
                    }
                    else if (status === 'topay') {
                        const pObj = payers.find(p => p.id === t.payerId);
                        const pName = pObj ? pObj.name : 'Waiting...';
                        payerHtml = `<div class="payer-tag" style="background:#fcefdc;">‚è≥ ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢: ${pName}</div>`;
                    }

                    let delBtn = '';
                    if (status === 'paid') {
                        delBtn = `<button class="delete-btn" onclick="event.stopPropagation(); deleteNote('${t.id}')">√ó</button>`;
                    }

                    el.innerHTML = `
                        ${delBtn}
                        ${assigneeHtml}
                        <div class="note-header">
                            <div style="display:flex; align-items:center;">
                                ${status === 'topay' ? `<input type="checkbox" class="bulk-chk" value="${t.id}" style="margin-right:8px; transform:scale(1.2); cursor:pointer;" onclick="event.stopPropagation()">` : ''}
                                <h3>${t.title} #${t.chapter}</h3>
                            </div>

                            <button class="btn-icon" onclick="sendDiscordWebhook(tasks.find(x=>x.id=='${t.id}'), '${status}')" title="Send to Discord"><i class="fa-brands fa-discord"></i></button>
                        </div>
                        <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">üïí ${new Date(t.createdAt).toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="job-checks">
                             <label class="check-box ${job.download ? 'checked' : ''}"><input type="checkbox" ${job.download ? 'checked' : ''} onclick="updateJob('${t.id}', 'download', this.checked)"> ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</label>
                             <label class="check-box ${job.clean ? 'checked' : ''}"><input type="checkbox" ${job.clean ? 'checked' : ''} onclick="updateJob('${t.id}', 'clean', this.checked)"> ‡∏î‡∏π‡∏î‡∏Ñ‡∏•‡∏µ‡∏ô 50‡∏ø</label>
                             <label class="check-box ${job.typeset ? 'checked' : ''}"><input type="checkbox" ${job.typeset ? 'checked' : ''} onclick="updateJob('${t.id}', 'typeset', this.checked)"> ‡∏•‡∏á‡∏Ñ‡∏≥ 30‡∏ø</label>
                        </div>
                        ${status === 'unpaid' ? `<button class="btn-icon" onclick="cancelTask('${t.id}')" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" style="margin-right:5px; color:#e74c3c; font-size:1.0rem;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>` : ''}
                        <div class="price-tag">üí∞ ${price} ‡∏ö‡∏≤‡∏ó</div>

                        ${payerHtml}
                    `;
                    cont[status].appendChild(el);
                });
            });
            document.getElementById('cnt-unpaid').textContent = groups.unpaid.length;
            document.getElementById('cnt-topay').textContent = groups.topay.length;
            document.getElementById('cnt-paid').textContent = groups.paid.length;
        }

        // --- Drag & Drop & Security ---
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function leaveDrop(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }

        async function drop(ev) {
            ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("text");
            const colId = ev.currentTarget.id;

            // Sync before move
            if (db) {
                try { await syncFromCloud(); } catch (e) { }
            }

            const task = tasks.find(t => t.id === id);
            if (!task) return;
            if (task.status === colId) return;

            // Scenario 1: Anything -> ToPay : Prompt for Payer (Notification only)
            if (colId === 'topay') {
                promptForPayment(id, colId);
                return;
            }

            // Scenario 2: Anything -> Paid : Prompt for Payer + Code (Auth)
            if (colId === 'paid') {
                promptForPayment(id, colId);
                return;
            }

            // Scenario 3: Paid -> Any Other : FORBIDDEN
            if (task.status === 'paid' && colId !== 'paid') {
                alert("‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ (Complete! Cannot move back)");
                return;
            }

            // Scenario 4: Any -> Unpaid (e.g. from ToPay): Just Move
            task.status = colId;
            autoSave(); renderTasks();
        }

        function promptForPayment(taskId, targetCol) {
            draggedTaskId = taskId;
            dragTargetCol = targetCol;

            const task = tasks.find(t => t.id === taskId);

            const isPaid = (targetCol === 'paid');
            const title = isPaid ? "üí∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (Confirm)" : "‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢ (Send to Payer)";
            const btnText = isPaid ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏à‡πà‡∏≤‡∏¢" : "‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î & ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";

            document.getElementById('payModalTitle').innerHTML = `<b>${title}</b><br>${task.title} #${task.chapter}<br>‡∏£‡∏≤‡∏Ñ‡∏≤: ${calculatePrice(task)} ‡∏ö‡∏≤‡∏ó`;

            const sel = document.getElementById('paySelectPayer');
            sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢ --</option>';
            payers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
            if (task.payerId) sel.value = task.payerId; // Pre-select if already assigned

            // Toggle Password & Slip
            const codeInput = document.getElementById('payInputCode');
            const codeLabel = document.querySelector('label[for="payInputCode"]') || codeInput.previousElementSibling;
            const slipInput = document.getElementById('payInputSlip');
            const slipLabel = document.getElementById('payLabelSlip');

            if (isPaid) {
                codeInput.style.display = 'block';
                if (codeLabel) codeLabel.style.display = 'block';
                slipInput.style.display = 'block';
                slipLabel.style.display = 'block';
            } else {
                codeInput.style.display = 'none';
                if (codeLabel) codeLabel.style.display = 'none';
                slipInput.style.display = 'none';
                slipLabel.style.display = 'none';
            }

            // Update button text
            const confirmBtn = document.querySelector('#paymentModal .btn-green');
            confirmBtn.innerText = btnText;

            document.getElementById('payInputCode').value = '';
            document.getElementById('paymentModal').style.display = 'flex';
        }

        async function confirmPayment() {
            // Sync before paying
            if (db) {
                try { await syncFromCloud(); } catch (e) { }
            }

            const payerId = document.getElementById('paySelectPayer').value;
            const code = document.getElementById('payInputCode').value;

            if (!payerId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô");

            const payer = payers.find(p => p.id === payerId);
            if (!payer) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢");

            // If PAID, check code. If TOPAY, skip code.
            if (dragTargetCol === 'paid') {
                if (payer.code !== code) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Incorrect Code)");
            }

            // Success
            const task = tasks.find(t => t.id === draggedTaskId);
            if (task) {
                task.status = dragTargetCol;
                task.payerId = payerId;
                if (dragTargetCol === 'paid') task.paidAt = new Date().toISOString();

                autoSave();
                renderTasks();

                const fileInput = document.getElementById('payInputSlip');
                const file = (dragTargetCol === 'paid' && fileInput.files.length > 0) ? fileInput.files[0] : null;

                await sendDiscordWebhook(task, dragTargetCol, file);
            }

            document.getElementById('paymentModal').style.display = 'none';
        }



        // --- JSON Backup System ---
        function exportJSONBoard() {
            const data = {
                pages: pages,
                projects: projects,
                tasks: tasks,
                assignees: assignees,
                payers: payers,
                exportedAt: new Date().toISOString()
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = `manga_board_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast("Backup JSON ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }

        function secureImportJSON() {
            const code = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:");
            if (code === "Reset888") {
                document.getElementById('fileInput').click();
            } else {
                if (code) alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î (Wrong Code)");
            }
        }


        function importJSONBoard() {
            document.getElementById('jsonInputBoard').click();
        }

        function handleJSONImportBoard(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.pages && data.projects && data.tasks) {
                        const confirmMsg = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n- Pages: ${data.pages.length}\n- Projects: ${data.projects.length}\n- Tasks: ${data.tasks.length}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cloud ‡∏î‡πâ‡∏ß‡∏¢)`;
                        if (confirm(confirmMsg)) {
                            pages = data.pages;
                            projects = data.projects;
                            tasks = data.tasks;
                            assignees = data.assignees || [];
                            payers = data.payers || [];

                            // Ensure integrity
                            if (!pages || pages.length === 0) pages = [{ id: 'p1', name: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' }];
                            if (!pages.find(p => p.id === currentPageId)) currentPageId = pages[0].id;

                            saveLocal();
                            syncToCloud();
                            refreshUI();
                            showToast('Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        }
                    } else {
                        showToast('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö)', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function cancelPayment() {
            document.getElementById('paymentModal').style.display = 'none';
            draggedTaskId = null;
        }

        // --- Advanced Summary ---
        function openSummaryModal() {
            // Populate filters
            const fill = (id, data, label) => {
                const el = document.getElementById(id);
                el.innerHTML = '<option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
                data.forEach(x => {
                    const o = document.createElement('option');
                    o.value = x.id; o.innerText = x[label];
                    el.appendChild(o);
                });
            };
            fill('filterSumPayer', payers, 'name');
            fill('filterSumAssignee', assignees, 'name');
            fill('filterSumPage', pages, 'name');

            // Populate unique projects
            const projEl = document.getElementById('filterSumProject');
            projEl.innerHTML = '<option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
            const uniqueProjs = [...new Set(projects.map(p => p.name))];
            uniqueProjs.sort().forEach(name => {
                const o = document.createElement('option');
                o.value = name; o.innerText = name;
                projEl.appendChild(o);
            });

            // Populate Months
            const monthEl = document.getElementById('filterSumMonth');
            if (monthEl) {
                monthEl.innerHTML = '<option value="ALL">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
                const months = [...new Set(tasks.map(t => t.createdAt.substring(0, 7)))]; // YYYY-MM
                months.sort().reverse().forEach(m => {
                    const o = document.createElement('option');
                    o.value = m; o.innerText = m;
                    monthEl.appendChild(o);
                });
            }

            renderSummaryTable();
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function renderSummaryTable() {
            const pFilter = document.getElementById('filterSumPayer').value;
            const aFilter = document.getElementById('filterSumAssignee').value;
            const pgFilter = document.getElementById('filterSumPage').value;
            const projFilter = document.getElementById('filterSumProject').value;
            const mFilter = document.getElementById('filterSumMonth') ? document.getElementById('filterSumMonth').value : 'ALL';
            const cont = document.getElementById('summaryTable');
            const statsCont = document.getElementById('summaryStats');

            let filtered = tasks.filter(t => {
                if (pgFilter !== 'ALL' && t.pageId !== pgFilter) return false;
                if (aFilter !== 'ALL' && t.assigneeId !== aFilter) return false;
                if (pFilter !== 'ALL' && t.payerId !== pFilter) return false;
                if (projFilter !== 'ALL' && t.title !== projFilter) return false;
                if (mFilter !== 'ALL' && !t.createdAt.startsWith(mFilter)) return false;
                return true;
            });

            let totalUnpaid = 0, countUnpaid = 0;
            let totalPaid = 0, countPaid = 0;

            filtered.forEach(t => {
                const p = calculatePrice(t);
                if (t.status === 'paid') { totalPaid += p; countPaid++; }
                else { totalUnpaid += p; countUnpaid++; }
            });

            // Stats
            statsCont.innerHTML = `
                <div style="flex:1; background:#e74c3c; color:white; padding:10px; border-radius:5px; text-align:center;">
                    <small>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢ (${countUnpaid})</small><br>
                    <span style="font-size:1.2rem; font-weight:bold;">${totalUnpaid.toLocaleString()}</span>
                </div>
                <div style="flex:1; background:#27ae60; color:white; padding:10px; border-radius:5px; text-align:center;">
                    <small>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${countPaid})</small><br>
                    <span style="font-size:1.2rem; font-weight:bold;">${totalPaid.toLocaleString()}</span>
                </div>
            `;

            // Grouping
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            let groups = {};
            filtered.forEach(t => {
                const m = t.createdAt.substring(0, 7);
                if (!groups[m]) groups[m] = { total: 0, items: [] };
                groups[m].items.push(t);
                groups[m].total += calculatePrice(t);
            });

            // Render Grouped List
            let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
            html += `<tr style="background:#eee;"><th style="padding:5px; text-align:left;">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th style="padding:5px; text-align:left;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th><th style="padding:5px; text-align:left;">‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢</th><th style="padding:5px; text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>`;

            const sortedKeys = Object.keys(groups).sort().reverse();
            if (sortedKeys.length === 0) {
                html += '<tr><td colspan="4" style="padding:10px; text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            } else {
                sortedKeys.forEach(key => {
                    const g = groups[key];
                    html += `<tr style="background:#34495e; color:white;"><td colspan="4" style="padding:6px 10px;">üìÖ <b>${key}</b> (‡∏£‡∏ß‡∏°: ${g.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó)</td></tr>`;

                    g.items.forEach(t => {
                        let ag = assignees.find(x => x.id === t.assigneeId)?.name || '-';
                        let py = payers.find(x => x.id === t.payerId)?.name || '-';
                        let price = calculatePrice(t);
                        let color = t.status === 'paid' ? '#27ae60' : '#e74c3c';

                        html += `
                            <tr style="border-bottom:1px solid #f1f1f1;">
                                <td style="padding:5px;"><b>${t.title}</b> #${t.chapter}</td>
                                <td style="padding:5px;">${ag}</td>
                                <td style="padding:5px;">${py}</td>
                                <td style="padding:5px; text-align:right; color:${color}; font-weight:bold;">${price}</td>
                            </tr>
                        `;
                    });
                });
            }

            html += '</table>';
            cont.innerHTML = html;
        }

        function resetAllData() {
            const c = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (Reset Code) to confirm:");
            if (c === "Reset888") {
                if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (Cannot Undo)")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            } else {
                if (c) alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î (Wrong Code)");
            }
        }

        function saveToJSON() {
            const blob = new Blob([JSON.stringify({ pages, projects, tasks, assignees, payers, currentPageId, cloudConfig }, null, 2)], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'MangaBoard_Ultimate_Protected.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function loadFromJSON(inp) {
            if (!inp.files[0]) return;
            const r = new FileReader(); r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (d.pages) {
                        pages = d.pages; projects = d.projects; tasks = d.tasks;
                        assignees = d.assignees; payers = d.payers || [];
                        currentPageId = d.currentPageId; cloudConfig = d.cloudConfig;
                        payers.forEach(p => { if (!p.code) p.code = ''; });
                        autoSave(); refreshUI(); alert("Success");
                    }
                } catch (err) { alert("Error"); }
            };
            r.readAsText(inp.files[0]); inp.value = '';
        }

        // --- Bulk Payment System ---
        function openBulkPayModal() {
            const chks = document.querySelectorAll('.bulk-chk:checked');
            if (chks.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏á‡∏≤‡∏ô");

            // Aggregate Data
            const selectedTasks = [];
            let totalPrice = 0;

            chks.forEach(chk => {
                const t = tasks.find(x => x.id === chk.value);
                if (t) {
                    selectedTasks.push(t);
                    totalPrice += calculatePrice(t);
                }
            });

            // Render Preview
            const previewEl = document.getElementById('bulkPreview');
            previewEl.innerHTML = selectedTasks.map(t => `<div>- ${t.title} #${t.chapter} (${calculatePrice(t)})</div>`).join('');

            document.getElementById('bulkTotalLabel').innerText = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

            // Fill Payer Select
            const sel = document.getElementById('bulkSelectPayer');
            sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢ --</option>';
            payers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.textContent = p.name;
                sel.appendChild(opt);
            });

            // Clear Inputs
            document.getElementById('bulkInputCode').value = '';
            document.getElementById('bulkInputSlip').value = '';

            document.getElementById('bulkPaymentModal').style.display = 'flex';
        }

        async function confirmBulkPayment() {
            // 1. Validate
            const payerId = document.getElementById('bulkSelectPayer').value;
            const code = document.getElementById('bulkInputCode').value;
            const slipFile = document.getElementById('bulkInputSlip').files[0];

            if (!payerId) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢");

            const payer = payers.find(p => p.id === payerId);
            if (!payer) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢");

            if (payer.code !== code) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î!");

            // Capture Selected IDs BEFORE Sync (because sync calls renderTasks -> destroys checkboxes)
            const chks = document.querySelectorAll('.bulk-chk:checked');
            const selectedIds = Array.from(chks).map(c => c.value);

            if (selectedIds.length === 0) return alert("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (No tasks selected)");

            // 2. Sync
            if (db) { try { await syncFromCloud(); } catch (e) { } }

            // 3. Process Items
            // const chks = document.querySelectorAll('.bulk-chk:checked'); // <- OLD BUGGY WAY
            const processedTasks = [];
            let totalPrice = 0;

            // Use current tasks state after sync
            selectedIds.forEach(id => {
                const t = tasks.find(x => x.id === id);
                if (t && t.status === 'topay') { // Double check status
                    t.status = 'paid';
                    t.payerId = payerId;
                    t.paidAt = new Date().toISOString();
                    processedTasks.push(t);
                    totalPrice += calculatePrice(t);
                }
            });

            if (processedTasks.length === 0) return alert("No tasks to pay? (Tasks might have been moved or deleted remotely)");

            autoSave();
            renderTasks();
            document.getElementById('bulkPaymentModal').style.display = 'none';

            // 4. Send Webhook
            await sendBulkDiscordWebhook(processedTasks, totalPrice, payer, slipFile);
            showToast("‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        }

        async function sendBulkDiscordWebhook(taskList, total, payer, file) {
            const url = cloudConfig.webhookPaid;
            if (!url) return;

            // Group by Title
            const grouped = {};
            taskList.forEach(t => {
                if (!grouped[t.title]) grouped[t.title] = [];
                grouped[t.title].push(t.chapter);
            });

            // Format Lists
            // * free Haram ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 16 , 17
            let descLines = [];
            for (const [title, chapters] of Object.entries(grouped)) {
                const mergedChaps = mergeChapters(chapters);
                descLines.push(`  * ${title} ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${mergedChaps}`);
            }

            const payerTag = (payer.discordId) ? `<@${payer.discordId}>` : payer.name;

            const content = `> **‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß**\n${descLines.join('\n')}\n> ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n> ${payerTag}`;

            const payload = {
                content: content,
                allowedMentions: { users: [payer.discordId] }
            };

            try {
                if (file) {
                    const formData = new FormData();
                    formData.append('payload_json', JSON.stringify(payload));
                    formData.append('file', file);
                    await fetch(url, { method: 'POST', body: formData });
                } else {
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
            } catch (e) { console.error(e); }
        }

        function mergeChapters(chapList) {
            // 1. Expand ranges (1-3 -> 1,2,3)
            let nums = new Set();
            chapList.forEach(c => {
                if (c.includes('-')) {
                    const [s, e] = c.split('-').map(Number);
                    for (let i = s; i <= e; i++) nums.add(i);
                } else {
                    nums.add(parseFloat(c));
                }
            });

            const sorted = Array.from(nums).sort((a, b) => a - b);
            if (sorted.length === 0) return chapList.join(', ');

            // 2. Group back to ranges
            let ranges = [];
            if (sorted.length > 0) {
                let start = sorted[0];
                let prev = sorted[0];

                for (let i = 1; i < sorted.length; i++) {
                    if (sorted[i] === prev + 1) {
                        prev = sorted[i];
                    } else {
                        ranges.push(start === prev ? `${start}` : `${start}-${prev}`);
                        start = sorted[i];
                        prev = sorted[i];
                    }
                }
                ranges.push(start === prev ? `${start}` : `${start}-${prev}`);
            }

            return ranges.join(' , ');
        }

        function showToast(message, type = 'success') {
            // Remove existing toasts to prevent overlap
            document.querySelectorAll('.toast-notification').forEach(el => el.remove());

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            if (type === 'error') toast.style.backgroundColor = '#c0392b';
            toast.innerHTML = `<i class="fa-solid fa-info-circle"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>